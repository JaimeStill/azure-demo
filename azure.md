# Azure Demo Infrastructure

* [Resource Group](#resource-group)
* [Key Vault](#key-vault)
* [Azure AD Auth](#azure-ad-auth)
* [Azure Container Registry](#azure-container-registry)
    * [Build Images](#build-images)
* [Azure App Service](#azure-app-service)
    * [Logging](#logging)
    * [Continuous Deployment](#continuous-deployment)
* [Azure Container Registry Webhooks](#azure-container-registry-webhoooks)
* [CORS Configuration](#cors-configuration)
* [Grant Key Vault Access](#grant-key-vault-access)

This document will walk through each step of the [create.sh](./azure/create.sh) script and show the infrastructure that is being created and configured.

[`. init-variables.sh`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L4) sets all of the environment variables used throughout the script to refer to the names of the infrastructure being generated. See [init-variables.sh](https://github.com/JaimeStill/azure-demo/blob/main/azure/init-variables.sh).

## Resource Group
[Back to Top](#azure-demo-infrastructure)

[`az group create`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L7) establishes a resource group to aggregate all of the related Azure services that will be generated by the rest of the script. Isolating capabilities by resource group allows you to easily contain and manage related resources without affecting other cloud infrastructure.

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/905b8c03-0eaa-4d90-a855-5eee062179ed)

## Key Vault
[Back to Top](#azure-demo-infrastructure)

[`az keyvault create`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L12) establishes an [Azure Key Vault](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L12) for managing secrets (API keys, connection strings, etc.).

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/38728376-980a-4042-baa1-8fe5e89ef650)

## Azure AD Auth
[Back to Top](#azure-demo-infrastructure)

Lines [23 - 168](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L23) configure and persist all of the OAuth and OpenIDConnect app registrations and configuration necessary for facilitating Azure AD authorization for the [API](https://github.com/JaimeStill/azure-demo/tree/main/src/jps-core-api) and [SPA App](https://github.com/JaimeStill/azure-demo/tree/main/src/jps-core-spa).

Lines [104 - 121](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L104) automatically update the [API](https://github.com/JaimeStill/azure-demo/blob/main/src/jps-core-api/appsettings.json) and [CLI](https://github.com/JaimeStill/azure-demo/blob/main/src/cli/appsettings.json) appsettings with the generated values needed to facilitate AD auth.

**App Registration**

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/4a5ee7eb-4d7f-4f4c-9770-f5ca09439a88)

**API Authentication Configuration**

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/b7e70349-0fab-4091-bb66-585079130460)

**API Optional Claims**  

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/9fd593e9-2ec1-469b-9bf4-0a4831a5c6c6)

**API Exposure**  

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/421d8f45-4bf3-442f-bd74-7a8809c204d3)

**API App Roles**  

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/a77f04c3-f641-4aae-8454-f9008627e166)

**SPA App Authentication**  

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/eb401bfa-bd02-4da7-a476-db28cb167f9a)

**SPA App API Permissions**

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/129b12de-f142-4b03-ab62-a53687ce247b)

For isolated examples of Azure AD integration, see the following:
* [MSAL Interactive Auth](https://github.com/JaimeStill/learning-azure/tree/main/exercises/azure-ad/01-msal-interactive-auth)
* [MSAL Protect Web API](https://github.com/JaimeStill/learning-azure/tree/main/exercises/azure-ad/02-msal-protect-web-api)
* [SPA Auth](https://github.com/JaimeStill/learning-azure/tree/main/exercises/azure-ad/03-spa)
* [SPA to API](https://github.com/JaimeStill/learning-azure/tree/main/exercises/azure-ad/04-spa-to-api)

## Azure Container Registry
[Back to Top](#azure-demo-infrastructure)

[`az acr create`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L171) creates an [Azure Container Registry](https://azure.microsoft.com/en-us/products/container-registry) for hosting generated Docker images.

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/c1e19d65-6c30-4c72-9a54-ae84a6b0223b)

### Build Images
[Back to Top](#azure-demo-infrastructure)

[`az acr build`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L195) generates an image for each of the app projects and pushes them out to the previously generated Azure Container Registry.

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/28e7df8f-9a90-4082-a592-5a927832df7f)

## Azure App Service
[Back to Top](#azure-demo-infrastructure)

[`az appservice plan create`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L216) creates an [App Service plan](https://learn.microsoft.com/en-us/azure/app-service/overview-hosting-plans) for generated Azure App Service instances.

[`az webapp create`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L223) generates an Azure App Service for each app project and uses the linked docker image from the container registry.

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/57712064-ae6c-46ab-8d34-c52d6dbbc288)

**Deployed Sync Server**

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/1137e290-7c2a-4c82-ac20-3d8555e9baac)

**Deployed Processor Service**

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/05d5f448-0893-419d-835d-36ce661bdf52)

**Deployed App API**  

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/ed6f5dcf-0dbd-435e-886a-ce042bc4f3d9)

**Deployed SPA App**

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/a585f756-e2cd-49e4-981a-927a10070f4c)

### Logging
[Back to Top](#azure-demo-infrastructure)

[`az webapp log config`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L256) configures logging for each Azure App Service instance.

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/08f3342d-2a05-4585-b79b-092b0269bb2f)

### Continuous Deployment
[Back to Top](#azure-demo-infrastructure)

[`az webapp deployment container config`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L277) enables continous deployment for each Azure App Service instance. Whenever a new image is pushed to Azure Container Registry, the corresponding Azure App Service instance will automatically update itself to the new image instance.

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/1ba57b49-2314-47f9-9773-ad0a327efc19)

## Azure Container Registry Webhoooks
[Back to Top](#azure-demo-infrastructure)

[`az acr webhook create`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L326) generates the web hooks needed for Azure Container Registry to push newly received images to their corresponding App Service instance.

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/179f5aff-3a19-4690-a559-36ad6e3a7046)

## CORS Configuration
[Back to Top](#azure-demo-infrastructure)

[`az webapp cors add`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L355) configures CORS on the sync server to allow the SPA to send and receive web socket broadcasts. [`az resource update`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L361) directly below enables the *Access-Control-Allow-Credentials* header.

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/7e975a2b-7daa-48c3-be8e-ae0c4dd16ebc)

## Grant Key Vault Access
[Back to Top](#azure-demo-infrastructure)

Line [370 - 395](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L370) configures the App API to access the Key Vault. 

The Key Vault name is added to the app settings with a `VaultName` key ([`az webapp config appsettings set`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L370)):

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/1ec05bdf-d0ee-4006-9599-98bb7048a6e3)

The App API creates a Managed Identity (the Azure Services equivalent to a service account) that is used to grant access to the Key Vault ([`az webapp identity assign`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L376)):

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/ffa2f4af-cd5f-4864-8038-1edee151c190)

[`az keyvault set-policy`](https://github.com/JaimeStill/azure-demo/blob/main/azure/create.sh#L392) grants the `get list` secret permissions to the App API managed identity:

![image](https://github.com/JaimeStill/azure-demo/assets/14102723/1b37a266-8fd4-48b6-afcd-92fdbc5259f3)